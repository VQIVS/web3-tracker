{{template "layout" .}}

{{define "embed"}}
<div class="card">
    <h2>ðŸ“Š Portfolio Overview</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h3 style="margin-bottom: 10px; font-size: 1.2rem;">Total Wallets</h3>
            <p style="font-size: 2.5rem; font-weight: bold; margin: 0;" id="total-wallets">{{.Portfolio.TotalWallets}}</p>
        </div>
        <div style="background: linear-gradient(135deg, #51cf66, #40c057); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h3 style="margin-bottom: 10px; font-size: 1.2rem;">Total Balance</h3>
            <p style="font-size: 2.5rem; font-weight: bold; margin: 0;" id="total-balance">{{.Portfolio.TotalBalance}} ETH</p>
        </div>
    </div>
    
    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <button onclick="updateAllBalances()" class="btn btn-success">ðŸ”„ Update All Balances</button>
        <a href="/wallets" class="btn btn-primary">âž• Manage Wallets</a>
    </div>

    <div class="loading">
        <div class="spinner"></div>
        <p>Updating balances...</p>
    </div>
</div>

{{if .Portfolio.WalletBalances}}
<div class="card">
    <h2>ðŸ’¼ Wallet Balances</h2>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;" id="wallets-table">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Address</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Label</th>
                    <th style="padding: 15px; text-align: right; border-bottom: 2px solid #dee2e6;">Balance (ETH)</th>
                    <th style="padding: 15px; text-align: center; border-bottom: 2px solid #dee2e6;">Last Updated</th>
                </tr>
            </thead>
            <tbody id="wallets-tbody">
                {{range .Portfolio.WalletBalances}}
                <tr style="border-bottom: 1px solid #dee2e6;" data-address="{{.Address}}">
                    <td style="padding: 15px; font-family: monospace; font-size: 0.9rem;">
                        <span class="address-short">{{slice .Address 0 6}}...{{slice .Address -4 0}}</span>
                        <button onclick="copyAddress('{{.Address}}')" style="margin-left: 10px; background: none; border: none; cursor: pointer; font-size: 0.8rem;">ðŸ“‹</button>
                    </td>
                    <td style="padding: 15px;">
                        {{if .Label}}{{.Label}}{{else}}<em style="color: #6c757d;">No label</em>{{end}}
                    </td>
                    <td style="padding: 15px; text-align: right; font-weight: bold; color: #28a745;" class="balance-cell">{{.BalanceETH}} ETH</td>
                    <td style="padding: 15px; text-align: center; color: #6c757d; font-size: 0.9rem;" class="updated-cell">{{.UpdatedAt.Format "15:04:05"}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{else}}
<div class="card" style="text-align: center; padding: 40px;">
    <h3 style="color: #6c757d; margin-bottom: 15px;">No wallets found</h3>
    <p style="color: #6c757d;">Add your first wallet to start tracking</p>
    <a href="/wallets" class="btn btn-primary" style="margin-top: 15px;">âž• Add Your First Wallet</a>
</div>
{{end}}

<script>
// Auto-refresh portfolio data every 30 seconds without page reload
let autoRefreshInterval;

async function fetchPortfolioData() {
    try {
        const response = await fetch('/api/portfolio');
        const data = await response.json();
        
        if (data.success && data.data) {
            updatePortfolioUI(data.data);
        }
    } catch (error) {
        console.error('Error fetching portfolio data:', error);
    }
}

function updatePortfolioUI(portfolio) {
    // Update totals
    document.getElementById('total-wallets').textContent = portfolio.total_wallets || 0;
    document.getElementById('total-balance').textContent = (portfolio.total_balance_eth || '0') + ' ETH';
    
    // Update wallet table
    const tbody = document.getElementById('wallets-tbody');
    if (tbody && portfolio.wallet_balances) {
        portfolio.wallet_balances.forEach(wallet => {
            const row = document.querySelector(`tr[data-address="${wallet.address}"]`);
            if (row) {
                const balanceCell = row.querySelector('.balance-cell');
                const updatedCell = row.querySelector('.updated-cell');
                
                if (balanceCell) {
                    balanceCell.textContent = wallet.balance_eth + ' ETH';
                }
                if (updatedCell) {
                    const now = new Date();
                    updatedCell.textContent = now.toLocaleTimeString();
                }
            }
        });
    }
}

async function updateAllBalances() {
    showLoading(true);
    
    try {
        const response = await fetch('/api/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('All balances updated successfully!', 'success');
            // Fetch updated data without page reload
            await fetchPortfolioData();
        } else {
            showAlert(data.message || 'Failed to update balances', 'error');
        }
    } catch (error) {
        showAlert('Error updating balances: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function copyAddress(address) {
    navigator.clipboard.writeText(address).then(() => {
        showAlert('Address copied to clipboard!', 'success');
    }).catch(() => {
        showAlert('Failed to copy address', 'error');
    });
}

function startAutoRefresh() {
    // Refresh every 30 seconds
    autoRefreshInterval = setInterval(fetchPortfolioData, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Stop auto-refresh when page is hidden (tab switch, minimize, etc.)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
{{end}}
